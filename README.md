# UDP Hole Punching Example

UDP Hole Punching を確認するためのサンプルアプリケーションです。


## 環境構築

プロジェクトのルートディレクトリで次のコマンドを実行します:

```bash
npm install
```


## ローカルネットワークの端末同士でメッセージを送信/受信してみる

各端末でアプリケーションを起動します:

```bash
node bin/client.js
```

各端末でクライアントを立ち上げます。``run``の後の数字はクライアント端末に対するポートです。``0``を指定した場合は適当なポートが割り当てられます:

```bash
>> run 9011
Run Clint: Addresses [
  [127.0.0.1]:9011,
  [::1]:9011,
  [192.168.1.11]:9011,
  [fe80::14ee:c90:68e2:9231]:9011,
  [fe80::12ca:c82:53a4:2384]:9011,
]

Sending STUN packet

Received STUN: Packet {
  class: 1,
  method: 256,
  attrs: { '32': { family: 4, port: 9011, address: '32.1.5.26' } },
  tid: 47324631 }

Received NAT: Address [32.1.5.26]:9011
```

メッセージを相手端末に送信します:

```bash
>> send 192.168.1.51 9011 hello
```

メッセージを受信した端末では次のように表示されます:

```bash
>> Received UDP message: hello from [192.168.1.11]:9012
```


## UDP Hole Punching でメッセージを送信/受信してみる

異なるネットワークに存在する各端末でアプリケーションを起動します:

```bash
node bin/client.js
```

各端末でクライアントを立ち上げます。``run``の後の数字はクライアント端末に対するポートです。このポートは、メッセージを送信した際のマッピングに使用されるグローバル側のポートと同じまたは異なる場合の両方があります。``0``を指定した場合は適当なポートが割り当てられます:

```bash
>> run 9011
Run Clint: Addresses [
  [127.0.0.1]:9011,
  [::1]:9011,
  [192.168.1.11]:9011,
  [fe80::14ee:c90:68e2:9231]:9011,
  [fe80::12ca:c82:53a4:2384]:9011,
]

Sending STUN packet

Received STUN: Packet {
  class: 1,
  method: 256,
  attrs: { '32': { family: 4, port: 9011, address: '32.1.5.26' } },
  tid: 47324631 }

Received NAT: Address [32.1.5.26]:9011
```

最初のメッセージの送信には注意が必要で、お互いの端末で同時に(数秒の誤差以内で)メッセージを送信しなければなりません。次に端末Aと端末Bでメッセージを送受信する手順を示します。

端末Aで端末Bへのメッセージ送信コマンドを入力しておきます(まだEnterを押下しないでください):

```bash
>> send 22.86.125.143 51857 hello
```

端末Bで端末Aへのメッセージ送信コマンドを入力しておきます(まだEnterを押下しないでください):

```bash
>> send 32.1.5.26 9011 bonjour
```

端末Aと端末Bで同時にEnterを押下します。結果として両端末でメッセージが受信されます。

端末A:
```bash
Received UDP message: bonjour from [22.86.125.143]:51758
```

端末B:
```bash
Received UDP message: hello from [32.1.5.26]:9011
```

Note:
> 一度メッセージの送信/受信が行われると、両端末で同時にメッセージを送らなくてもメッセージの送信/受信を行えるようになります。一定時間メッセージのやりとりが行われなかった場合、再度同時にメッセージを送信する必要があります。

Note:
> 端末でセキュリティソフトが起動している場合、セキュリティソフトによっては UDP Hole Punching でメッセージを送信/受信ができないことがあります([ESET](https://www.eset.com/us/)が起動していると送受/受信きませんでした)。


